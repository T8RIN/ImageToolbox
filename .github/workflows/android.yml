name: Android CI

on:
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - uses: actions/checkout@v3

      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: gradle

      - name: Install Android SDK Command line tools and Build Tools 36
        run: |
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
            cd $ANDROID_SDK_ROOT/cmdline-tools
            wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
            unzip cmdline-tools.zip
            rm cmdline-tools.zip
            mv cmdline-tools latest
            yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;36.0.0"
        env:
            ANDROID_SDK_ROOT: ${{ runner.tool_cache }}/android-sdk
    
      
      - run: bash ./gradlew assembleRelease

      - name: Sign FOSS APK
        run: |
          echo "${SIGNING_KEY}" | base64 --decode > /tmp/keystore.jks
          chmod 600 /tmp/keystore.jks
          for apk in app/build/outputs/apk/foss/release/*.apk; do
            $ANDROID_SDK_ROOT/build-tools/36.0.0/apksigner sign \
              --ks /tmp/keystore.jks \
              --ks-key-alias "${ALIAS}" \
              --ks-pass pass:"${KEY_STORE_PASS}" \
              --key-pass pass:"${KEY_PASS}" \
              --out "$apk" \
              "$apk"
          done
          rm -f /tmp/keystore.jks
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASS: ${{ secrets.KEY_STORE_PASS }}
          KEY_PASS: ${{ secrets.KEY_STORE_PASS }}
          ANDROID_SDK_ROOT: ${{ runner.tool_cache }}/android-sdk

      - uses: actions/upload-artifact@v4
        with:
          name: Signed apks FOSS
          path: app/build/outputs/apk/foss/release/*.apk

      - name: Sign Market APK
        run: |
          echo "${SIGNING_KEY}" | base64 --decode > /tmp/keystore.jks
          chmod 600 /tmp/keystore.jks
          for apk in app/build/outputs/apk/market/release/*.apk; do
            $ANDROID_SDK_ROOT/build-tools/36.0.0/apksigner sign \
              --ks /tmp/keystore.jks \
              --ks-key-alias "${ALIAS}" \
              --ks-pass pass:"${KEY_STORE_PASS}" \
              --key-pass pass:"${KEY_PASS}" \
              --out "$apk" \
              "$apk"
          done
          rm -f /tmp/keystore.jks
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASS: ${{ secrets.KEY_STORE_PASS }}
          KEY_PASS: ${{ secrets.KEY_STORE_PASS }}
          ANDROID_SDK_ROOT: ${{ runner.tool_cache }}/android-sdk

      - uses: actions/upload-artifact@v4
        with:
          name: Signed apks Market
          path: app/build/outputs/apk/market/release/*.apk
